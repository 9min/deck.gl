# RFC: Layer Intersections

* **Authors**: Ravi Akkenapally
* **Date**: July 2018
* **Status**: For Review.


## Overview

deck.gl provides many layers to visualize the data. But in some cases it is very useful visualize intersection of one or more layers. For example a `HexagonLayer` is used to show the data aggregated to the hexagon bins, and a `ScatterplotLayer` can define regions of interest, and user is interested it visualizing hexagon aggregation only in regions defined by `ScatterplotLayer`. This RFC proposes new API to intersect a given layer using one or more other layers.


## Proposed

A new prop object `intersectLayers` is added for `Layer` class, that defines what layers to intersect with and what is the intersection operation.

To intersect with a layer with id `layerid-1` and discard all pixels that are not in region defined by `layerid-1`.

```
const intersectLayers = {
  layers: 'layerid-1'
  operation: 'filter'
}
```

To intersect with two layers and highlight all pixels in intersection region.

```
const intersectLayers = {
  layers: ['layerid-1', 'layer-id2']
  operation: 'highlight'
  highlightColor: [255, 0, 0, 255]
}
```


## Implementation

When a layer is being drawn , if it contains `intersectLayers` prop, a texture is generated by rendering all the layers into a `Framebuffer` object. This texture is then used to identify the intersection regions during layer's draw cycle.

### Building the Intersection Texture

In the beginning of `drawLayerInViewport`, we will check for `intersectLayers` prop and setup `Framebuffer` object (equal to he size of current viewport). All the layers specified in `intersectLayers` prop are rendered into this `Framebuffer` object. All we need from these layers is final pixel position, we can add fast render mode for all layers where features such as lighting and etc can be disabled, and we can enable such mode during this step.

### Performing Intersection operations

Above texture is sampled in Layers's vertex shader and a boolean varying, `inIntersectRegion` is set. This can be used in fragment shader to either discard or change color of the pixel. All this new shader functionality can be enabled by a uniform. We can be group all this vertex and fragment shader functionality into a shader module (`filterModule` ?).
